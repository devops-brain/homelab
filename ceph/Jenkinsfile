pipeline {
  agent {
    label "kubectl"
  }

  stages {
    stage('pull rook codebase'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh 'git clone --single-branch --branch release-1.5 https://github.com/rook/rook.git'
      }
    }
    stage('deploy rook dependencies for operator'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f rook/cluster/examples/kubernetes/ceph/crds.yaml -f rook/cluster/examples/kubernetes/ceph/common.yaml --wait=true"
      }
    }
    stage('deploy rook operator'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f rook/cluster/examples/kubernetes/ceph/operator.yaml --wait=true"
      }
    }
    stage('deploy ceph cluster through rook operator'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f ceph/rook-cluster/cluster.yaml --wait=true"
      }
    }
    stage('deploy ceph pools'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f ceph/rook-cluster/pools.yaml --wait=true"
      }
    }
    stage('deploy ceph as k8s csi storageclass for rbd and shared fs'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f ceph/rook-cluster/csi-storageclass.yaml --wait=true"
      }
    }
    stage('deploy ceph snapshots into k8s rbd'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "#kubectl apply -f rook/cluster/examples/kubernetes/ceph/csi/rbd/snapshotclass.yaml --wait=true"
      }
    }
    stage('deploy ceph snapshots into k8s fs'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "#kubectl apply -f rook/cluster/examples/kubernetes/ceph/csi/cephfs/snapshotclass.yaml --wait=true"
      }
    }
    stage('deploy ceph toolbox'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f rook/cluster/examples/kubernetes/ceph/toolbox.yaml --wait=true"
      }
    }
    stage('deploy mysql example to verify storage config is functional'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f rook/cluster/examples/kubernetes/ceph/toolbox.yaml --wait=true"
      }
    }
    stage('deploy wordpress example to verify storage config is functional'){
      steps {
        echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh "kubectl apply -f rook/cluster/examples/kubernetes/ceph/toolbox.yaml --wait=true"
      }
    }
  }
}